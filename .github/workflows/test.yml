name: Python CI

on:
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  lint:
    name: Lint and Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Rye
        uses: eifinger/setup-rye@v4
        with:
          enable-cache: true

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: |
            .venv
            ~/.cache/pip
            ~/.cache/rye
          key: ${{ runner.os }}-rye-${{ hashFiles('**/requirements*.lock', '**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-rye-

      - name: Sync dependencies
        run: |
          rye sync --features all-ci

      - name: Lint with Ruff
        run: |
          rye run ruff check modelaudit/ tests/

      - name: Check import organization with Ruff
        run: |
          rye run ruff check --select I modelaudit/ tests/

      - name: Check formatting with Ruff
        run: |
          rye run ruff format --check modelaudit/ tests/

  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Rye
        uses: eifinger/setup-rye@v4
        with:
          enable-cache: true

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: |
            .venv
            ~/.cache/pip
            ~/.cache/rye
          key: ${{ runner.os }}-rye-${{ hashFiles('**/requirements*.lock', '**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-rye-

      - name: Sync dependencies
        run: |
          rye sync --features all-ci

      - name: Type checking
        run: |
          rye run mypy modelaudit/ tests/

  test:
    name: Test Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Rye
        uses: eifinger/setup-rye@v4
        with:
          enable-cache: true
          version: latest

      - name: Pin Python version
        run: |
          rye pin ${{ matrix.python-version }}

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: |
            .venv
            ~/.cache/pip
            ~/.cache/rye
          key: ${{ runner.os }}-rye-py${{ matrix.python-version }}-${{ hashFiles('**/requirements*.lock', '**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-rye-py${{ matrix.python-version }}-
            ${{ runner.os }}-rye-

      - name: Sync dependencies
        run: |
          rye sync --features all-ci

      - name: Run fast tests (parallel execution)
        run: |
          rye run pytest -n auto -m "not slow and not integration and not performance" --cov=modelaudit --tb=short

      - name: Run slow/integration tests (if main branch)
        if: github.ref == 'refs/heads/main'
        timeout-minutes: 15
        run: |
          # Only run tests explicitly marked with @pytest.mark.slow or @pytest.mark.integration
          rye run pytest -n 1 --tb=short \
            tests/test_performance_benchmarks.py::TestPerformanceBenchmarks::test_stress_performance \
            tests/test_file_type_validation_integration.py::TestFileTypeValidationIntegration::test_performance_with_large_directories \
            tests/test_license_integration.py::TestLicenseIntegration::test_end_to_end_cli_integration || true

  test-numpy-compatibility:
    name: Test NumPy Compatibility - Python ${{ matrix.python-version }}, NumPy ${{ matrix.numpy-mode }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.11", "3.12"]
        numpy-mode: ["1.x", "2.x"]
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Rye
        uses: eifinger/setup-rye@v4
        with:
          enable-cache: true
          version: latest

      - name: Pin Python version
        run: |
          rye pin ${{ matrix.python-version }}

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: |
            .venv
            ~/.cache/pip
            ~/.cache/rye
          key: ${{ runner.os }}-rye-py${{ matrix.python-version }}-numpy${{ matrix.numpy-mode }}-${{ hashFiles('**/requirements*.lock', '**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-rye-py${{ matrix.python-version }}-numpy${{ matrix.numpy-mode }}-
            ${{ runner.os }}-rye-py${{ matrix.python-version }}-
            ${{ runner.os }}-rye-

      - name: Install with NumPy 1.x compatibility mode
        if: matrix.numpy-mode == '1.x'
        run: |
          rye sync --no-dev
          rye add --optional numpy1 'numpy>=1.19.0,<2.0'
          rye sync --features numpy1

      - name: Install with NumPy 2.x (default)
        if: matrix.numpy-mode == '2.x'
        run: |
          rye sync --features all-ci

      - name: Check NumPy version
        run: |
          rye run python -c "import numpy; print(f'NumPy version: {numpy.__version__}')"

      - name: Test scanner diagnostics
        run: |
          rye run modelaudit doctor --show-failed

      - name: Test basic scanning functionality
        run: |
          # Create a test file to scan
          echo "Testing basic scanning with NumPy ${{ matrix.numpy-mode }}"
          rye run python -c "import pickle; pickle.dump({'test': 'data'}, open('test_model.pkl', 'wb'))"
          rye run modelaudit scan test_model.pkl --format json --output test_results.json
          cat test_results.json

      - name: Run NumPy compatibility tests
        run: |
          rye run pytest tests/test_numpy_scanner.py -v
          rye run pytest tests/test_scanner_registry.py -v -k "numpy"

  build:
    name: Build and Package
    needs: [lint, type-check]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Rye
        uses: eifinger/setup-rye@v4
        with:
          enable-cache: true

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: |
            .venv
            ~/.cache/pip
            ~/.cache/rye
          key: ${{ runner.os }}-rye-${{ hashFiles('**/requirements*.lock', '**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-rye-

      - name: Sync dependencies
        run: |
          rye sync --features all-ci

      - name: Build package
        run: |
          rye build

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
