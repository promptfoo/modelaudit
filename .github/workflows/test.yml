name: Python CI

on:
  pull_request:
    paths-ignore:
      - "**.md"
      - "**.txt"
      - "**.rst"
      - "LICENSE*"
      - ".github/workflows/docs-check.yml"
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  # First, determine what changed to optimize subsequent jobs
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      python: ${{ steps.filter.outputs.python }}
      docker: ${{ steps.filter.outputs.docker }}
      workflows: ${{ steps.filter.outputs.workflows }}
      dependencies: ${{ steps.filter.outputs.dependencies }}
    steps:
      - uses: actions/checkout@v6
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            python:
              - '**.py'
              - 'pyproject.toml'
              - 'uv.lock'
            docker:
              - 'Dockerfile*'
              - '.dockerignore'
            workflows:
              - '.github/workflows/**'
            dependencies:
              - 'pyproject.toml'
              - 'uv.lock'

  lint:
    name: Lint and Format
    needs: changes
    # Always run on main branch, otherwise only if Python files changed
    if: github.ref == 'refs/heads/main' || needs.changes.outputs.python == 'true' || needs.changes.outputs.workflows == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Pin Python version
        run: |
          uv python pin 3.12

      - name: Cache Python dependencies
        uses: actions/cache@v5
        with:
          path: |
            .venv
            ~/.cache/pip
            ~/.cache/uv
          key: ${{ runner.os }}-uv-py3.12-${{ hashFiles('**/uv.lock', '**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-uv-py3.12-
            ${{ runner.os }}-uv-

      - name: Sync dependencies
        run: |
          uv sync --extra all-ci

      - name: Lint with Ruff
        run: |
          uv run ruff check modelaudit/ tests/

      - name: Check import organization with Ruff
        run: |
          uv run ruff check --select I modelaudit/ tests/

      - name: Check formatting with Ruff
        run: |
          uv run ruff format --check modelaudit/ tests/

  type-check:
    name: Type Check
    needs: changes
    # Only run if Python files changed
    if: github.ref == 'refs/heads/main' || needs.changes.outputs.python == 'true' || needs.changes.outputs.workflows == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Pin Python version
        run: |
          uv python pin 3.12

      - name: Cache Python dependencies
        uses: actions/cache@v5
        with:
          path: |
            .venv
            ~/.cache/pip
            ~/.cache/uv
          key: ${{ runner.os }}-uv-py3.12-${{ hashFiles('**/uv.lock', '**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-uv-py3.12-
            ${{ runner.os }}-uv-

      - name: Sync dependencies
        run: |
          uv sync --extra all-ci

      - name: Type checking
        run: |
          uv run mypy modelaudit/ tests/

      - name: Check for circular imports
        run: |
          set -euo pipefail
          python scripts/minimal_circular_check.py

  # Fast feedback job for immediate results
  quick-feedback:
    name: Quick Feedback (Python 3.12)
    needs: changes
    # Always run for fastest feedback
    if: github.ref == 'refs/heads/main' || needs.changes.outputs.python == 'true' || needs.changes.outputs.workflows == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Pin Python version
        run: |
          uv python pin 3.12

      - name: Cache Python dependencies
        uses: actions/cache@v5
        with:
          path: |
            .venv
            ~/.cache/pip
            ~/.cache/uv
          key: ${{ runner.os }}-uv-py3.12-${{ hashFiles('**/uv.lock', '**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-uv-py3.12-
            ${{ runner.os }}-uv-

      - name: Sync dependencies
        run: |
          uv sync --extra all-ci

      - name: Run fast tests with fail-fast
        run: |
          uv run pytest -x --maxfail=1 -n auto -m "not slow and not integration and not performance" --tb=short --durations=10

  windows-tests:
    name: Windows Tests (Python 3.11)
    needs: changes
    if: github.ref == 'refs/heads/main' || needs.changes.outputs.python == 'true' || needs.changes.outputs.workflows == 'true'
    runs-on: windows-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Pin Python version
        run: |
          uv python pin 3.11

      - name: Sync dependencies
        run: |
          uv sync --extra all-ci-windows

      - name: Run fast tests with fail-fast
        run: |
          uv run pytest -x --maxfail=1 -n auto -m "not slow and not integration and not performance" --tb=short --durations=10

  test:
    name: Test Python ${{ matrix.python-version }}
    needs: changes
    # Only run if Python files changed
    if: github.ref == 'refs/heads/main' || needs.changes.outputs.python == 'true' || needs.changes.outputs.workflows == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      matrix:
        # For PRs, only test min and max Python versions to save time
        # For main branch, test all versions
        # Note: Python 3.10+ supported (see pyproject.toml)
        # Python 3.10 gets NumPy 1.x, Python 3.11+ gets NumPy 2.x
        python-version: ${{ github.event_name == 'pull_request' && fromJSON('["3.10", "3.13"]') || fromJSON('["3.10", "3.11", "3.12", "3.13"]') }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Pin Python version
        run: |
          uv python pin ${{ matrix.python-version }}

      - name: Cache Python dependencies
        uses: actions/cache@v5
        with:
          path: |
            .venv
            ~/.cache/pip
            ~/.cache/uv
          key: ${{ runner.os }}-uv-py${{ matrix.python-version }}-${{ hashFiles('**/uv.lock', '**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-uv-py${{ matrix.python-version }}-
            ${{ runner.os }}-uv-

      - name: Sync dependencies
        run: |
          uv sync --extra all-ci

      - name: Run fast tests with fail-fast (PRs, Python 3.12 with coverage)
        if: github.event_name == 'pull_request' && matrix.python-version == '3.12'
        run: |
          uv run pytest -x --maxfail=1 -n auto -m "not slow and not integration and not performance" --cov=modelaudit --cov-report=xml --tb=short --durations=15

      - name: Run fast tests with fail-fast (PRs, non-3.12)
        if: github.event_name == 'pull_request' && matrix.python-version != '3.12'
        run: |
          uv run pytest -x --maxfail=1 -n auto -m "not slow and not integration and not performance" --tb=short --durations=15

      - name: Run slow/integration tests on PR (if labeled)
        # Run slow tests on PRs when the 'run-slow-tests' label is added
        # This allows developers to validate slow tests before merging
        if: github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'run-slow-tests') && matrix.python-version == '3.12'
        timeout-minutes: 20
        run: |
          echo "Running slow/integration tests due to 'run-slow-tests' label"
          uv run pytest -n auto -m "slow or integration or performance" --tb=short --durations=20

      - name: Run fast tests with coverage (main branch only)
        if: github.ref == 'refs/heads/main' && matrix.python-version == '3.12'
        run: |
          uv run pytest -n auto -m "not slow and not integration and not performance" --cov=modelaudit --cov-report=xml --tb=short --durations=15

      - name: Run fast tests without coverage (main branch, non-3.12)
        if: github.ref == 'refs/heads/main' && matrix.python-version != '3.12'
        run: |
          uv run pytest -n auto -m "not slow and not integration and not performance" --tb=short --durations=15

      - name: Run slow/integration tests (main branch only)
        # Run ALL slow/integration/performance tests on main branch.
        # Tests with missing dependencies auto-skip via pytest.importorskip() or framework markers.
        # Runs on Python 3.12 only to keep CI time reasonable.
        if: github.ref == 'refs/heads/main' && matrix.python-version == '3.12'
        timeout-minutes: 20
        run: |
          # Run all slow, integration, and performance tests
          uv run pytest -n auto -m "slow or integration or performance" --tb=short --durations=20

      - name: Upload coverage to Codecov
        if: matrix.python-version == '3.12'
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage.xml
          fail_ci_if_error: false
          verbose: true

  test-numpy-compatibility:
    name: Test NumPy ${{ matrix.numpy-mode }} - Python ${{ matrix.python-version }}
    needs: changes
    # Only run on main branch or if dependencies changed
    if: github.ref == 'refs/heads/main' || needs.changes.outputs.dependencies == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      matrix:
        # Test both NumPy versions with appropriate Python versions:
        # - NumPy 1.x on Python 3.10 (last version supporting NumPy 1.x)
        # - NumPy 2.x on Python 3.11+ (requires Python >=3.11)
        # Reduced matrix for PRs, full matrix for main branch
        include: ${{ github.event_name == 'pull_request' && fromJSON('[{"python-version":"3.10","numpy-mode":"1.x"},{"python-version":"3.11","numpy-mode":"2.x"}]') || fromJSON('[{"python-version":"3.10","numpy-mode":"1.x"},{"python-version":"3.11","numpy-mode":"2.x"},{"python-version":"3.12","numpy-mode":"2.x"},{"python-version":"3.13","numpy-mode":"2.x"}]') }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Pin Python version
        run: |
          uv python pin ${{ matrix.python-version }}

      - name: Cache Python dependencies
        uses: actions/cache@v5
        with:
          path: |
            .venv
            ~/.cache/pip
            ~/.cache/uv
          key: ${{ runner.os }}-uv-py${{ matrix.python-version }}-numpy${{ matrix.numpy-mode }}-${{ hashFiles('**/uv.lock', '**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-uv-py${{ matrix.python-version }}-numpy${{ matrix.numpy-mode }}-
            ${{ runner.os }}-uv-py${{ matrix.python-version }}-
            ${{ runner.os }}-uv-

      - name: Install dependencies
        run: |
          # Dependencies are automatically version-matched based on Python version
          # Python 3.10: NumPy 1.x + TensorFlow 2.13+
          # Python 3.11+: NumPy 2.x + TensorFlow 2.17+
          uv sync --extra all-ci

      - name: Check NumPy version
        run: |
          uv run python -c "import numpy; print(f'NumPy version: {numpy.__version__}')"

      - name: Test scanner diagnostics
        run: |
          uv run modelaudit doctor --show-failed

      - name: Test basic scanning functionality
        run: |
          # Create a test file to scan
          echo "Testing basic scanning with NumPy ${{ matrix.numpy-mode }}"
          uv run python -c "import pickle; pickle.dump({'test': 'data'}, open('test_model.pkl', 'wb'))"
          uv run modelaudit scan test_model.pkl --format json --output test_results.json
          cat test_results.json

      - name: Run NumPy compatibility tests
        run: |
          uv run pytest tests/scanners/test_numpy_scanner.py -v
          uv run pytest tests/scanners/test_scanner_registry.py -v -k "numpy"

  test-vendored-protos:
    name: Test Vendored TensorFlow Protos
    needs: changes
    # Run on main branch or if Python/dependency files changed
    if: github.ref == 'refs/heads/main' || needs.changes.outputs.python == 'true' || needs.changes.outputs.dependencies == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Pin Python version
        run: |
          uv python pin 3.12

      - name: Install WITHOUT TensorFlow
        run: |
          # Install only base dependencies - no tensorflow extra
          uv sync

      - name: Verify TensorFlow is NOT installed
        run: |
          uv run python -c "
          try:
              import tensorflow
              print('ERROR: TensorFlow should not be installed!')
              exit(1)
          except ImportError:
              print('✓ TensorFlow is not installed (expected)')
          "

      - name: Verify vendored protos load correctly
        run: |
          uv run python -c "
          import modelaudit.protos
          assert modelaudit.protos._check_vendored_protos(), 'Protos should be available'
          assert modelaudit.protos.is_using_vendored_protos(), 'Should use vendored protos'
          print('✓ Vendored protos loaded successfully')
          "

      - name: Test safe SavedModel scanning
        run: |
          uv run python -m modelaudit tests/assets/samples/tensorflow/safe_savedmodel/ --format json | \
            python -c "import sys,json; d=json.load(sys.stdin); assert len(d['issues'])==0, f'Expected 0 issues, got {len(d[\"issues\"])}'; print('✓ Safe model: 0 issues')"

      - name: Test malicious SavedModel scanning
        run: |
          # Should detect PyFunc operation
          uv run python -m modelaudit tests/assets/samples/tensorflow/malicious_pyfunc/ --format json 2>/dev/null | \
            python -c "import sys,json; d=json.load(sys.stdin); critical=[i for i in d['issues'] if i['severity']=='critical']; assert len(critical)>=1, f'Expected critical issues, got {len(critical)}'; print(f'✓ Malicious model: {len(critical)} critical issue(s) detected')"

  build:
    name: Build and Package
    needs: changes
    # Always build on main, otherwise only if Python files changed
    if: github.ref == 'refs/heads/main' || needs.changes.outputs.python == 'true' || needs.changes.outputs.dependencies == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Pin Python version
        run: |
          uv python pin 3.12

      - name: Cache Python dependencies
        uses: actions/cache@v5
        with:
          path: |
            .venv
            ~/.cache/pip
            ~/.cache/uv
          key: ${{ runner.os }}-uv-py3.12-${{ hashFiles('**/uv.lock', '**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-uv-py3.12-
            ${{ runner.os }}-uv-

      - name: Sync dependencies
        run: |
          uv sync --extra all-ci

      - name: Build package
        run: |
          uv build

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: dist
          path: dist/

  # Summary job to ensure all required checks pass
  ci-success:
    name: CI Success
    needs:
      [
        quick-feedback,
        lint,
        type-check,
        windows-tests,
        test,
        test-numpy-compatibility,
        test-vendored-protos,
        build,
      ]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check if all jobs succeeded
        run: |
          # A job is considered successful if it either succeeded or was skipped
          # (skipped means the job's conditions weren't met, which is fine)
          QUICK_FEEDBACK_RESULT="${{ needs.quick-feedback.result }}"
          LINT_RESULT="${{ needs.lint.result }}"
          TYPE_CHECK_RESULT="${{ needs.type-check.result }}"
          WINDOWS_RESULT="${{ needs.windows-tests.result }}"
          TEST_RESULT="${{ needs.test.result }}"
          NUMPY_RESULT="${{ needs.test-numpy-compatibility.result }}"
          PROTOS_RESULT="${{ needs.test-vendored-protos.result }}"
          BUILD_RESULT="${{ needs.build.result }}"

          # Check if conditional jobs should have run
          ON_MAIN_BRANCH="${{ github.ref == 'refs/heads/main' }}"
          DEPENDENCIES_CHANGED="${{ needs.changes.outputs.dependencies == 'true' }}"
          PYTHON_CHANGED="${{ needs.changes.outputs.python == 'true' }}"

          echo "Job results:"
          echo "  quick-feedback: $QUICK_FEEDBACK_RESULT"
          echo "  lint: $LINT_RESULT"
          echo "  type-check: $TYPE_CHECK_RESULT"
          echo "  windows-tests: $WINDOWS_RESULT"
          echo "  test: $TEST_RESULT"
          echo "  test-numpy-compatibility: $NUMPY_RESULT (should run: on_main=$ON_MAIN_BRANCH, deps_changed=$DEPENDENCIES_CHANGED)"
          echo "  test-vendored-protos: $PROTOS_RESULT (should run: on_main=$ON_MAIN_BRANCH, python_changed=$PYTHON_CHANGED, deps_changed=$DEPENDENCIES_CHANGED)"
          echo "  build: $BUILD_RESULT"

          # Check if any job failed or was cancelled
          FAILED=false

          [[ "$QUICK_FEEDBACK_RESULT" == "failure" || "$QUICK_FEEDBACK_RESULT" == "cancelled" ]] && FAILED=true
          [[ "$LINT_RESULT" == "failure" || "$LINT_RESULT" == "cancelled" ]] && FAILED=true
          [[ "$TYPE_CHECK_RESULT" == "failure" || "$TYPE_CHECK_RESULT" == "cancelled" ]] && FAILED=true
          [[ "$WINDOWS_RESULT" == "failure" || "$WINDOWS_RESULT" == "cancelled" ]] && FAILED=true
          [[ "$TEST_RESULT" == "failure" || "$TEST_RESULT" == "cancelled" ]] && FAILED=true
          [[ "$BUILD_RESULT" == "failure" || "$BUILD_RESULT" == "cancelled" ]] && FAILED=true

          # NumPy compatibility job only runs on main or when dependencies change
          if [[ "$ON_MAIN_BRANCH" == "true" || "$DEPENDENCIES_CHANGED" == "true" ]]; then
            echo "NumPy job should have run - checking for failure"
            [[ "$NUMPY_RESULT" == "failure" || "$NUMPY_RESULT" == "cancelled" ]] && FAILED=true
          else
            echo "NumPy job was not expected to run - treating as OK"
          fi

          # Vendored protos job runs on main or when python/dependencies change
          if [[ "$ON_MAIN_BRANCH" == "true" || "$PYTHON_CHANGED" == "true" || "$DEPENDENCIES_CHANGED" == "true" ]]; then
            echo "Vendored protos job should have run - checking for failure"
            [[ "$PROTOS_RESULT" == "failure" || "$PROTOS_RESULT" == "cancelled" ]] && FAILED=true
          else
            echo "Vendored protos job was not expected to run - treating as OK"
          fi

          if [[ "$FAILED" == "true" ]]; then
            echo "Some CI checks failed!"
            exit 1
          else
            echo "All CI checks passed (or were skipped due to path filters)!"
            exit 0
          fi
