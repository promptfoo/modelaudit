# False Positives & Scanner Issues Report

## Executive Summary

Tested **44 legitimate model files** generated with real ML libraries (sklearn, PyTorch, NumPy, SafeTensors, etc.).

**Results:**
- ‚úÖ **26 files** - Clean (no warnings/errors)
- ‚ö†Ô∏è  **5 files** - False positive warnings
- ‚ùå **3 files** - Scanner bugs/crashes
- üêõ **1 CRITICAL** - Legitimate PyTorch model flagged as malicious

## ‚úÖ Clean Scans (26 files)

These files scan without any warnings or issues:

### Pickle/Sklearn Models
- `sklearn_logistic.pkl`
- `sklearn_logistic.pickle`
- `sklearn_rf.joblib`
- `simple_model.pkl`
- `simple_model.pickle`
- `simple_model.dill`

### PyTorch Models
- `pytorch_state_dict.pth` ‚úì
- `pytorch_checkpoint.ckpt` ‚úì
- `pytorch_weights.pth` ‚úì
- `pytorch_model.pt` ‚úì

### HDF5/Keras
- `keras_model.h5`
- `keras_model.hdf5`
- `keras_model.keras`

### NumPy
- `model_weights.npy` ‚úì

### SafeTensors
- `model.safetensors` ‚úì

### GGUF/GGML
- `llama_model.gguf`
- `legacy_model.ggml`
- `legacy_model.ggmf`
- `legacy_model.ggjt`

### Archives
- `model_archive.zip`
- `model_archive.tar`
- `model_archive.tar.gz`

### ExecuTorch
- `mobile_model.pte`
- `mobile_model.ptl`

### OpenVINO
- `openvino_model.xml`
- `openvino_model.bin`

### Specialized
- `optimized_model.engine`
- `optimized_model.plan`
- `paddle_model.pdiparams`
- `pytorch_model.bin`
- `raw_weights.bin`
- `simple_model.onnx`

---

## ‚ö†Ô∏è False Positive Warnings (5 files)

### 1. NumPy .npz Files (2 files)
**Files:** `model_params.npz`, `model_weights.npz`

**Warning:**
```
File type validation failed: extension indicates numpy but magic bytes indicate zip
```

**Root Cause:**
- `.npz` files are ZIP archives by design (NumPy's compressed format)
- Validation expects "numpy" magic bytes, gets "zip" instead
- **This is NOT a security issue** - it's the correct format

**Fix Needed:**
```python
# In validate_file_type()
if ext_format == "numpy" and path.endswith(".npz"):
    return header_format in {"zip", "numpy"}  # Accept both
```

**Priority:** Medium (False positive, but annoying)

---

### 2. JAX/Flax MessagePack File
**File:** `jax_model.msgpack`

**Warning:**
```
File type validation failed: extension indicates msgpack but magic bytes indicate unknown
```

**Root Cause:**
- MessagePack has variable magic bytes depending on content type
- Simple MessagePack structures don't have distinctive magic bytes
- File is legitimate MessagePack format

**Fix Needed:**
- Add MessagePack magic byte detection (starts with `0x81`, `0x82`, etc.)
- OR mark msgpack format as "hard to validate" like tflite/coreml

**Priority:** Low (uncommon format)

---

### 3. PaddlePaddle Model
**File:** `paddle_model.pdmodel`

**Warning:**
```
File type validation failed: extension indicates paddle but magic bytes indicate unknown
```

**Root Cause:**
- PaddlePaddle format is protobuf-based but lacks distinctive magic bytes
- File is legitimate (minimal protobuf structure)

**Fix Needed:**
- Mark paddle format as "hard to validate" like TensorRT
- OR add protobuf detection for `.pdmodel` files

**Priority:** Low (minimal user impact)

---

### 4. PMML XML Root Element
**File:** `regression_model.pmml`

**Warning:**
```
Root element is not <PMML>
```

**Root Cause:**
- PMML file starts with `<?xml version="1.0" encoding="UTF-8"?>`
- Then `<PMML version="4.4" ...>`
- Scanner may be checking wrong position or has XML parsing issue

**Fix Needed:**
- Investigate PMML scanner XML parsing
- May need to handle XML declaration before root element

**Priority:** Medium (PMML is supported format)

---

## ‚ùå Scanner Bugs (3 files)

### 1. üö® CRITICAL: PyTorch Full Model False Positive
**File:** `pytorch_full_model.pt`

**Issue:**
```
CRITICAL: Malicious code detected: OBJ(4), NEWOBJ(4) opcodes detected
```

**Root Cause:**
- **This is a LEGITIMATE PyTorch model** saved with `torch.save(model, path)`
- PyTorch uses pickle internally, which legitimately uses OBJ/NEWOBJ opcodes
- **FALSE POSITIVE** - scanner flags standard PyTorch serialization as malicious

**Why This Happens:**
- OBJ/NEWOBJ opcodes are used to instantiate Python objects
- PyTorch models are Python `nn.Module` classes
- These opcodes are **required** for proper deserialization

**Fix Needed:**
- **Option 1:** Whitelist common ML framework classes (torch.nn.Module, etc.)
- **Option 2:** Add context-aware detection (check if imports are from torch/sklearn/tf)
- **Option 3:** Lower severity for models from trusted sources (HuggingFace whitelist)

**Priority:** üî¥ **CRITICAL** - Breaks legitimate PyTorch workflow

**Impact:** High - Many PyTorch users will see false positives

---

### 2. TFLite Scanner Crash
**File:** `mobile_model.tflite`

**Issue:**
```
ERROR: unpack_from requires a buffer of at least 860636760 bytes
```

**Root Cause:**
- TFLite scanner tries to read data without validating file size
- Buffer overflow error causes scan to fail
- Legitimate TFLite file generated by TensorFlow

**Fix Needed:**
```python
# In TFLite scanner, before unpacking:
if file_size < required_offset + required_size:
    return ScanResult(issues=[Issue(
        severity="WARNING",
        description="File too small for expected TFLite structure"
    )])
```

**Priority:** üî¥ **HIGH** - Causes scan failures

---

### 3. TensorFlow Protobuf Crash
**File:** `frozen_model.pb`

**Issue:**
```
libc++abi: terminating due to uncaught exception of type std::__1::system_error: mutex lock failed
```

**Root Cause:**
- Process-level crash (mutex error)
- May be related to protobuf/TensorFlow library issue
- Crashes entire scan process

**Fix Needed:**
- Add exception handling around protobuf parsing
- Isolate protobuf scanner to prevent crashes
- May need subprocess isolation for C++ libraries

**Priority:** üî¥ **HIGH** - Crashes entire scanner

---

## üìä Summary Statistics

| Category | Count | % |
|----------|-------|---|
| ‚úÖ Clean | 26 | 59% |
| ‚ö†Ô∏è  Warnings (False Positives) | 5 | 11% |
| ‚ùå Errors/Crashes | 3 | 7% |
| **Total Tested** | **44** | **100%** |

### By Severity

- üî¥ **CRITICAL**: 1 (PyTorch full model false positive)
- üî¥ **HIGH**: 2 (TFLite crash, TF protobuf crash)
- üü° **MEDIUM**: 2 (.npz validation, PMML parsing)
- üü¢ **LOW**: 2 (msgpack, paddle validation)

---

## üéØ Recommendations

### Immediate Actions (P0)

1. **Fix PyTorch Full Model False Positive**
   - Add whitelist for `torch.nn.Module` and related classes
   - Or add context check: if `torch` imports detected, lower severity
   - Most impactful fix for user experience

2. **Fix TFLite Scanner Crash**
   - Add file size validation before unpacking
   - Prevent buffer overflow errors

3. **Fix TensorFlow Protobuf Crash**
   - Add exception handling
   - Consider subprocess isolation

### Short Term (P1)

4. **Fix .npz Validation**
   - Accept ZIP magic bytes for `.npz` extension
   - Update validation rules

5. **Investigate PMML Parsing**
   - Debug XML root element detection
   - Test with various PMML files

### Long Term (P2)

6. **Improve MessagePack Detection**
   - Add magic byte patterns for MessagePack
   - Or mark as "hard to validate"

7. **Add PaddlePaddle Support**
   - Better protobuf detection for Paddle files
   - Or mark as special case

---

## üî¨ Test Methodology

All models were generated using legitimate ML libraries:
- **scikit-learn**: 0.24.2
- **PyTorch**: 2.8.0
- **NumPy**: 1.21+
- **SafeTensors**: 0.6.2

No hand-crafted byte sequences were used. All files are genuine model exports from their respective frameworks.

---

## üìÅ Files Included

Test dataset location: `.local/test_models/`

- `generate_legitimate_models.py` - Generation script (uses real ML libraries)
- `test_scanner.sh` - Individual file scanner script
- `README.md` - Dataset documentation
- `FALSE_POSITIVES.md` - This report

---

## üöÄ Next Steps

1. File GitHub issues for each bug
2. Create PRs to fix validation rules
3. Add regression tests for legitimate models
4. Consider adding "trusted framework" whitelist
